#!/usr/bin/env zsh

#/ DESCRIPTION:
#/   Clean up Homebrew packages not listed in machine-specific Brewfiles.
#/   Removes packages, casks, and dependencies no longer needed.
#/
#/ USAGE:
#/   cleanup [--dry-run]
#/
#/ OPTIONS:
#/   --dry-run    Show what would be removed without making changes

setopt ERR_EXIT NO_UNSET PIPE_FAIL

# Source helper functions if not already loaded
typeset -r SCRIPT_DIR="${0:A:h}"
typeset -r DOTFILES_ROOT="${SCRIPT_DIR:h:h}"
if [[ ! $(typeset -f section) ]]; then
  source "${DOTFILES_ROOT}/inc/helpers.zsh"
fi

# Change to script directory to find Brewfiles
cd "$SCRIPT_DIR"

# Machine hostnames (change these to match your machines)
typeset -r WORK_MACHINE_NAME="0x73746f65"
typeset -r PERSONAL_MACHINE_NAME="6x73746f65"
typeset -r BREWFILE_LOCAL="Brewfile.local"

# Cleanup trap to remove temporary Brewfile.local on exit
cleanup_brewfile() {
  [[ -f "$BREWFILE_LOCAL" ]] && rm -f "$BREWFILE_LOCAL" "${BREWFILE_LOCAL}.lock.json"
}
trap cleanup_brewfile EXIT INT TERM

# Parse command-line arguments
typeset dry_run=false
if [[ "$1" == "--dry-run" ]]; then
  dry_run=true
  section "dry run" "üç∫ üôà No changes will be made"
else
  section "homebrew" "üç∫ üíª cleanup"
fi

# Remove existing Brewfile.local if present
if [[ -f "$BREWFILE_LOCAL" ]]; then
  section "homebrew" "üç∫ üßπ Cleaning existing $BREWFILE_LOCAL"
  rm -f "$BREWFILE_LOCAL" "${BREWFILE_LOCAL}.lock.json" 2>/dev/null || true
fi

# Verify required Brewfiles exist
[[ ! -f Brewfile ]] && abort "Brewfile not found" && exit 1
[[ ! -f Brewfile.optional ]] && abort "Brewfile.optional not found" && exit 1

# Get the local computer's hostname
typeset machine_name
machine_name=$(hostname)

# Combine base Brewfiles
typeset brewfile_all
brewfile_all="$(cat Brewfile)\n\n$(cat Brewfile.optional)"

# Load machine-specific Brewfile based on hostname
case "$machine_name" in
  "$WORK_MACHINE_NAME")
    section "homebrew" "üç∫ üíº"
    [[ ! -f Brewfile.work ]] && abort "Brewfile.work not found" && exit 1
    brewfile_all="${brewfile_all}\n\n$(cat Brewfile.work)"
    ;;
  "$PERSONAL_MACHINE_NAME")
    section "homebrew" "üç∫ üè°"
    [[ ! -f Brewfile.personal ]] && abort "Brewfile.personal not found" && exit 1
    brewfile_all="${brewfile_all}\n\n$(cat Brewfile.personal)"
    ;;
  *)
    abort "Unknown machine name: $machine_name"
    exit 1
    ;;
esac

# Add VS Code extensions
[[ ! -f Brewfile.vsc ]] && abort "Brewfile.vsc not found" && exit 1
brewfile_all="${brewfile_all}\n\n$(cat Brewfile.vsc)"

# Write unified Brewfile
echo "$brewfile_all" > "$BREWFILE_LOCAL"

# Run brew autoremove to clean up lingering dependencies
typeset cmd="brew autoremove"
[[ "$dry_run" == "true" ]] && cmd="${cmd} --dry-run"
formatexec "$cmd"

# Run brew bundle cleanup (may return 1 in dry-run mode if packages would be removed)
cmd="brew bundle cleanup --file $BREWFILE_LOCAL"
[[ "$dry_run" == "false" ]] && cmd="${cmd} --force"
formatexec "$cmd" || true

ok "homebrew üç∫ done"
